// Configuração do Cliente Prisma
generator client {
  provider = "prisma-client-js"
}

// Configuração do Banco de Dados (Vercel Postgres)
datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL") // Usa o Pool para performance
  directUrl = env("POSTGRES_URL_NON_POOLING") // Usa direta para migrações
}

// --- MODELO DE USUÁRIO ---
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password      String
  
  // Configurações Financeiras
  spendingLimit Decimal?  @default(0) @db.Decimal(10, 2)
  savingsGoal   String?   @default("Caixinha dos Sonhos")

  // Cache de IA (Economia de custos)
  lastAdvice     String?  @db.Text
  lastAdviceDate DateTime?

  // Relacionamentos
  transactions  Transaction[]
  recurring     RecurringTransaction[]
  badges        Badge[]
  categories    Category[]
  
  // Lógica de Casal (Parceiro)
  // Relação reflexiva: Um usuário pode ter um parceiro
  partnerId     String?
  partner       User?     @relation("PartnerLink", fields: [partnerId], references: [id])
  partners      User[]    @relation("PartnerLink") 

  sentRequests     PartnerRequest[] @relation("Sender")
  receivedRequests PartnerRequest[] @relation("Receiver")

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

// --- MODELO DE TRANSAÇÃO (Principal) ---
model Transaction {
  id          String   @id @default(uuid())
  
  // Dados Básicos
  amount      Decimal  @db.Decimal(10, 2) // Decimal para precisão monetária
  description String
  category    String
  type        String   // INCOME (Entrada), EXPENSE (Saída), INVESTMENT (Investimento)
  date        DateTime @default(now())

  // NOVOS CAMPOS: Parcelamento e Pagamento
  paymentMethod String?  @default("DEBIT") // "CREDIT", "DEBIT", "PIX", "CASH"
  installments  Int?     @default(1)       // Total de parcelas (ex: 12)
  currentInstallment Int? @default(1)      // Parcela atual (ex: 1)
  isPaid        Boolean  @default(true)    // false = Fatura aberta (Crédito)

  // Relacionamento com Usuário
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // OTIMIZAÇÃO DE PERFORMANCE:
  // Índices para deixar o Dashboard e o cálculo de saldo rápidos
  @@index([userId, date])
  @@index([userId, type]) 
}

// --- MODELO DE TRANSAÇÃO RECORRENTE (Assinaturas) ---
model RecurringTransaction {
  id          String   @id @default(uuid())
  amount      Decimal  @db.Decimal(10, 2)
  description String
  category    String
  type        String
  frequency   String   // MONTHLY (Mensal)
  active      Boolean  @default(true)
  nextRun     DateTime
  
  // NOVO CAMPO: Dia preferido para o pagamento
  dayOfMonth  Int?     // Ex: Dia 5, Dia 10...

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// --- GAMIFICAÇÃO (Medalhas) ---
model Badge {
  id          String   @id @default(uuid())
  code        String   // Código único da medalha (ex: "SAVER_1")
  name        String
  description String
  icon        String
  earnedAt    DateTime @default(now())

  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- CATEGORIAS PERSONALIZADAS ---
model Category {
  id      String @id @default(uuid())
  name    String
  type    String? // INCOME ou EXPENSE (Opcional pois pode ter sido criado antes)
  icon    String?
  color   String? // Cor da categoria (Hex ou nome)
  
  userId  String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// --- SOLICITAÇÕES DE PARCEIRO ---
model PartnerRequest {
  id         String   @id @default(uuid())
  status     String   // PENDING, ACCEPTED, REJECTED
  
  senderId   String
  sender     User     @relation("Sender", fields: [senderId], references: [id])
  
  receiverId String
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  
  createdAt  DateTime @default(now())
}